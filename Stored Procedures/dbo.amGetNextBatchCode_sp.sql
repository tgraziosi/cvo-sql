SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO

/*                                                      
               Confidential Information                  
    Limited Distribution of Authorized Persons Only       
    Created 2007 and Protected as Unpublished Work       
          Under the U.S. Copyright Act of 1976            
 Copyright (c) 2007 Epicor Software Corporation, 2007    
                  All Rights Reserved                    
*/                                                



































































  



					  

























































 




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































 

















































































































































































































		











































































































































































































































































































































































































































































										 








































































































































































































 
CREATE PROCEDURE [dbo].[amGetNextBatchCode_sp]
(
    @batch_type		smallint,					
 	@user_id        smUserID,					
    @date_applied	smJulianDate,				
 	@company_code	smCompanyCode,			  	
    @next_batch		smBatchCode 	OUTPUT,		
	@debug_level	smDebugLevel 	= 0		 	
)

AS 
DECLARE 
	@batch_description	varchar(30),
	@doc_name			char(30),
	@jul_date			int,
    @jul_time			int,	      
    @mask				varchar(16), 
	@next_number		int,
	@user_name			smUserName,						
	@result				smErrorCode,
	@rowcount			smCounter,
	@tran_started		smLogical,
	@org_id			varchar(30)			

IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + "  " + "amnxtbat.cpp" + ", line " + STR( 77, 5 ) + " -- ENTRY: "

IF @debug_level > 3
BEGIN
	SELECT	"Batch Type   = " + CONVERT(char(20), @batch_type)
	SELECT	"User ID      = " + CONVERT(char(20), @user_id)
	SELECT	"Date Applied = " + CONVERT(char(20), @date_applied)
END




SELECT	@next_number	= NULL




EXEC appdate_sp @jul_date output
EXEC apptime_sp @jul_time output 





IF @batch_type = 10000 + 50
BEGIN
	EXEC @result = amGetString_sp
					1,
					@batch_description OUTPUT


	IF @result <> 0
		RETURN @result
END

ELSE IF	 @batch_type = 10000 + 100
BEGIN
	EXEC @result = amGetString_sp
					2,
					@batch_description OUTPUT


	IF @result <> 0
		RETURN @result
END

ELSE
BEGIN
	EXEC @result = amGetString_sp
					3,
					@batch_description OUTPUT


	IF @result <> 0
		RETURN @result
END

EXEC @result = amGetString_sp
					4,
					@doc_name OUTPUT

IF @result <> 0
	RETURN @result




SELECT	@user_name 	= user_name
FROM	ewusers_vw
WHERE	user_id		= @user_id

IF @debug_level > 3
BEGIN
	SELECT	"Batch desc = " + @batch_description
	SELECT	"Doc Name   = " + @doc_name
	SELECT	"User Name  = " + @user_name
END




SELECT	@mask			= batch_ctrl_num_mask
FROM	batchnum




IF ( @@trancount = 0 )
BEGIN
	BEGIN TRAN
	SELECT	@tran_started = 1
END






WHILE 1=1
	BEGIN
	


	UPDATE	batchnum 
	SET		next_batch_ctrl_num = next_batch_ctrl_num + 1

	SELECT @result = @@error, @rowcount = @@rowcount
	IF 	@result <> 0
	OR	@rowcount = 0		 
	BEGIN
		IF ( @tran_started = 1 )
			ROLLBACK TRAN
		
		SELECT	@next_batch = " "
		RETURN 20609
	END
	
	
	IF @next_number IS NULL
		SELECT	@next_number = next_batch_ctrl_num - 1
		FROM	batchnum

	
	EXEC	fmtctlnm_sp	
				@next_number, 
				@mask, 
				@next_batch	OUTPUT, 
				@result		OUTPUT

	IF ( @result != 0 )
	BEGIN
		IF ( @tran_started = 1 )
			ROLLBACK TRAN
		
		SELECT	@next_batch = " "
		RETURN 20609
	END

	
	IF NOT EXISTS(	SELECT	batch_ctrl_num
			     	FROM 	batchctl
			     	WHERE	batch_ctrl_num = @next_batch )
		BREAK

	
	SELECT	@next_number = next_batch_ctrl_num
	FROM	batchnum
END


IF ((select count(1) from #amsumval) = 0) 
	SET @org_id = (select organization_id from Organization where outline_num = '1')	
ELSE
	SELECT @org_id = MIN(isnull(asset_org_id, '')) 	
        FROM #amsumval











INSERT batchctl 
(	
		batch_ctrl_num, 
		batch_description,
		start_date,
		start_time,
		completed_date,
		completed_time,
		control_number,
		control_total,
		actual_number,
		actual_total,
		batch_type,
		document_name,
		hold_flag,
		posted_flag,
		void_flag,
		selected_flag,
		number_held,
		date_applied,
		date_posted,
		time_posted,
		start_user,
		completed_user,
		posted_user,
	  	company_code,
		org_id 					
)

VALUES
( 	
		@next_batch, 
		@batch_description, 
		@jul_date, 
		@jul_time, 
		0, 				
		0, 				
		0, 				
		0.0, 			
		0, 				
		0.0, 			
		@batch_type, 
		@doc_name,
        0, 			
		0, 				
		0, 				
		0, 				
		0, 				
		@date_applied, 
		0, 				
		0, 				
		@user_name, 
		" ", 			
		" ", 			
		@company_code,
		@org_id				
)

IF ( @@rowcount != 1 )
	GOTO rollback_trx

IF ( @tran_started = 1 )
	COMMIT TRAN

IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + "  " + "amnxtbat.cpp" + ", line " + STR( 307, 5 ) + " -- EXIT: "

RETURN 0

rollback_trx:
IF ( @tran_started = 1 )
	ROLLBACK TRAN

RETURN	20609
GO
GRANT EXECUTE ON  [dbo].[amGetNextBatchCode_sp] TO [public]
GO
