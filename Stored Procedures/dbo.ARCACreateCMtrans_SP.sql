SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO





























  



					  

























































 

























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































                       











































CREATE PROC [dbo].[ARCACreateCMtrans_SP]			@batch_ctrl_num		varchar(16),
											@debug_level		smallint,
											@perf_level			smallint

AS








DECLARE
        @PERF_time_last     datetime

SELECT  @PERF_time_last = GETDATE()

















									






											  
DECLARE
	@result			int,
	@trx_type		smallint,
	@trx_ctrl_num	varchar(16),
	@doc_ctrl_num	varchar(16),
	@customer_code	varchar(8),
	@date_doc		int,
	@trx_desc		varchar(40),
	@cash_acct_code	varchar(32),
	@amt_payment	float,
	@home_currency	varchar(8),
	@date_applied	int,
	@last_trx_ctrl	varchar(16),
	@min_trx_ctrl_num	varchar(16),
	@deposit_num		varchar(16),
	@org_id			varchar(30)



IF ( @perf_level >= 1 ) EXEC perf_sp @batch_ctrl_num, 'arcaccm.cpp', 62, 'Entering ARCACreateCMtrans_SP', @PERF_time_last OUTPUT

BEGIN
	IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + '  ' + 'arcaccm.cpp' + ', line ' + STR( 65, 5 ) + ' -- ENTRY: '

	SELECT	@home_currency = glco.home_currency
	FROM	glco	
	
	










































	 
	SELECT 	@last_trx_ctrl = ' '

	IF(@debug_level > 0)
	BEGIN
		SELECT 'dump of arinppyt_work before cm details are created'
		SELECT	'doc_ctrl_num = ' + doc_ctrl_num +
			' trx_ctrl_num = ' + trx_ctrl_num +
			' trx_type = ' + STR(trx_type,6) +
			' nat_cur_code = ' + nat_cur_code +
			' amt_payment = ' + STR(amt_payment,12,3)
		FROM	#arinppyt_work
	END
	
	WHILE ( 1 = 1 )
	
	



	
	


	BEGIN
			
		SELECT @trx_ctrl_num = NULL

        	SELECT	@min_trx_ctrl_num = MIN(trx_ctrl_num)
        	FROM 	#arinppyt_work, apcash ap
		WHERE	#arinppyt_work.batch_code = @batch_ctrl_num
 		AND	#arinppyt_work.payment_type = 1
 		AND	#arinppyt_work.trx_type between 2113 and 2121
 		AND	#arinppyt_work.void_type < 4	
		AND	#arinppyt_work.cash_acct_code = ap.cash_acct_code
		AND	#arinppyt_work.nat_cur_code = ap.nat_cur_code	
 		AND  	trx_ctrl_num > @last_trx_ctrl
	 	IF( @@error != 0 )
		BEGIN
			IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + '  ' + 'arcaccm.cpp' + ', line ' + STR( 152, 5 ) + ' -- EXIT: '
			RETURN 34563
		END
		
        	SELECT	@trx_ctrl_num = trx_ctrl_num,
			@doc_ctrl_num = doc_ctrl_num,
			@amt_payment = -amt_payment,
			@trx_type = trx_type,
			@date_doc = date_doc,
			@date_applied = date_applied,
			@trx_desc = trx_desc,
			@cash_acct_code = cash_acct_code,
			@customer_code = customer_code,
			@deposit_num = deposit_num,
			@org_id	 = org_id
		FROM 	#arinppyt_work
		WHERE	batch_code = @batch_ctrl_num
 		AND	trx_type between 2113 and 2121
 		AND	payment_type = 1
 		AND	trx_ctrl_num = @min_trx_ctrl_num
     
		IF( @@error != 0 )
		BEGIN
			IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + '  ' + 'arcaccm.cpp' + ', line ' + STR( 175, 5 ) + ' -- EXIT: '
			RETURN 34563
		END

		


		IF ( @trx_ctrl_num IS NULL )
		BEGIN
			IF ( @debug_level > 2 ) SELECT CONVERT(char,getdate(),109) + '  ' + 'arcaccm.cpp' + ', line ' + STR( 184, 5 ) + ' -- MSG: ' + 'No more transactions to post'
			BREAK
		END
		

		SELECT	@last_trx_ctrl = @trx_ctrl_num

		IF (@debug_level > 0)
		BEGIN
			SELECT	'values passed to cm for validation'
			SELECT	'deposit number being adjusted = ' + @deposit_num +
				'doc_ctrl_num = ' + @doc_ctrl_num
		END


		EXEC @result = cminpcr_sp		2000,
							2,
							@trx_type,
							@trx_ctrl_num,
							@doc_ctrl_num,
							@date_doc,
							@trx_desc,
							@customer_code,  
							' ',		   
							@cash_acct_code,
							@amt_payment,
							0,		   
							@date_applied,
							@deposit_num,
							2111,
							@deposit_num,
							0,
							NULL,
							@org_id

		IF(@result != 0)
		BEGIN
			IF ( @debug_level > 1 ) SELECT CONVERT(char,getdate(),109) + '  ' + 'arcaccm.cpp' + ', line ' + STR( 221, 5 ) + ' -- EXIT: '
			RETURN @result
		END
	END 

END 


GO
GRANT EXECUTE ON  [dbo].[ARCACreateCMtrans_SP] TO [public]
GO
